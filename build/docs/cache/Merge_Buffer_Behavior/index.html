<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-cache/Merge_Buffer_Behavior">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">&lt;a name=&quot;_toc1444127171&quot;&gt;&lt;/a&gt;**7. Merge Buffer Behavior** | FPGA Multi-Agent FabrIc Architecture </title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://noamsabb.github.io /fpga_mafia_doc/docs/cache/Merge_Buffer_Behavior"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="&lt;a name=&quot;_toc1444127171&quot;&gt;&lt;/a&gt;**7. Merge Buffer Behavior** | FPGA Multi-Agent FabrIc Architecture "><meta data-rh="true" name="description" content="In this chapter we will explain the Merge Buffer behavior through different cases"><meta data-rh="true" property="og:description" content="In this chapter we will explain the Merge Buffer behavior through different cases"><link data-rh="true" rel="icon" href="/fpga_mafia_doc/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://noamsabb.github.io /fpga_mafia_doc/docs/cache/Merge_Buffer_Behavior"><link data-rh="true" rel="alternate" href="https://noamsabb.github.io /fpga_mafia_doc/docs/cache/Merge_Buffer_Behavior" hreflang="en"><link data-rh="true" rel="alternate" href="https://noamsabb.github.io /fpga_mafia_doc/docs/cache/Merge_Buffer_Behavior" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/fpga_mafia_doc/blog/rss.xml" title="FPGA Multi-Agent FabrIc Architecture  RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/fpga_mafia_doc/blog/atom.xml" title="FPGA Multi-Agent FabrIc Architecture  Atom Feed"><link rel="stylesheet" href="/fpga_mafia_doc/assets/css/styles.d34731ec.css">
<link rel="preload" href="/fpga_mafia_doc/assets/js/runtime~main.5e157adf.js" as="script">
<link rel="preload" href="/fpga_mafia_doc/assets/js/main.229969e3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/fpga_mafia_doc/"><div class="navbar__logo"><img src="/fpga_mafia_doc/img/BIU.png" alt="BIU logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/fpga_mafia_doc/img/BIU.png" alt="BIU logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">FPGA MAFIA</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/fpga_mafia_doc/docs/cache/cache_intro">Cache</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/fpga_mafia_doc/docs/how_to/github_action">How To</a><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/cache_intro">Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/cache_overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/High_level_block_description">High level block description</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/High_level_Transaction_Flows">High level Transaction Flows</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/fpga_mafia_doc/docs/cache/Merge_Buffer_Behavior">Merge Buffer Behavior</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/Verification">Verification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/Assumption_Assertions">Assumption &amp; Assertions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/Appendix">Appendix</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/fpga_mafia_doc/docs/cache/ABD_notes">ABD Notes</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/fpga_mafia_doc/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Merge Buffer Behavior</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1><a name="_toc1444127171"></a><strong>7. Merge Buffer Behavior</strong></h1><p>In this chapter we will explain the Merge Buffer behavior through different cases</p><p>The <a name="_int_nz7q838o"></a>merge<!-- -->_<!-- -->buffer is a buffer in our TQ that will store partial data during the time we are waiting for the Cache Line Data to be filled by the Far Memory.
Every entry in the TQ is linked to a Merge Buffer entry then we need to take care that every request to the same Cache-Line will never allocate a new entry if there already is an entry in the TQ for that specific Cache-Line.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="71-read-after-write-same-cache-line-word-hit"><a name="_toc761038880"></a><strong>7.1 Read After Write (same Cache Line, word hit)</strong><a href="#71-read-after-write-same-cache-line-word-hit" class="hash-link" aria-label="Direct link to 71-read-after-write-same-cache-line-word-hit" title="Direct link to 71-read-after-write-same-cache-line-word-hit">​</a></h2><p>In this case, if the Write request got a Miss, it will update the Far Memory (fill request) that we need a data and update the TQ that he got a Miss.
The partial write data (no a full CL) will be stored in the Merge Buffer until we get the fill response from FM.
During this time, if the TQ get a Read Request to the same Cache Line + same word offset:</p><ol><li>We know that the lookup will get a Miss from the pipe. </li><li>TQ merge buffer will response with TQ Hit to this specific word (Word Hit).</li><li>It will indicate to the pipe that there is no need for a fill from Far Memory. (Cancel the fill)</li><li>It will read it straight from the Merge Buffer and return it to Core. Make sure the Merge buffer response will be the correct cycle (Q3) of the pipe lookup that we already know will miss.</li></ol><p>This will happen only if the TQ is not in S<!-- -->_<!-- -->FILL<!-- -->_<!-- -->LU state. If it is, the data will be read from the Tag Array and not directly from the Merge Buffer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="72-read-after-write-same-cache-line-word-miss"><a name="_toc1647958394"></a><strong>7.2 Read After Write (same Cache Line, word Miss)</strong><a href="#72-read-after-write-same-cache-line-word-miss" class="hash-link" aria-label="Direct link to 72-read-after-write-same-cache-line-word-miss" title="Direct link to 72-read-after-write-same-cache-line-word-miss">​</a></h2><p>Just like in the last case the Write request got a Miss and is waiting for the data from Far Memory and stored the partial write to the Merge Buffer.
During this time, we are getting a Read Request to the same CacheLine but this time to another word. In this case, contrary to the last one, we cannot read the data from the Merge Buffer because we got Word Miss.
1<!-- -->.<!-- --> TQ will send a Stall signal to the core so it will wait for the data to be filled.
2<!-- -->.<!-- --> Once the TQ gets the Far Memory response for the Write request and will fill our Cache Line in the Merge Buffer, this line will be written to the Data Cache Array with an indication “rd<!-- -->_<!-- -->fill<!-- -->_<!-- -->rsp”.
3<!-- -->.<!-- --> The pipe will write the fill + return the data to the TQ as if there was a read hit so it will be sent as a Read response to the Core in Q3.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="73-write-after-write-same-cache-line-samedifferent-word"><a name="_toc1077647588"></a><strong>7.3 Write After Write (Same Cache Line, same/different word)</strong><a href="#73-write-after-write-same-cache-line-samedifferent-word" class="hash-link" aria-label="Direct link to 73-write-after-write-same-cache-line-samedifferent-word" title="Direct link to 73-write-after-write-same-cache-line-samedifferent-word">​</a></h2><p>For this case, we have already tried to Write to the same Cache Line but now we want to make another Write to a different word in that Cache Line. The first write will miss and send the fill request to FM + allocate a merge<!-- -->_<!-- -->buffer entry.
The second Write request will enter the pipe, get a Write Miss indication but this time it will not make a Far Memory request because we have an indication from the TQ that we have a “Merge Buffer Hit” which mean we have already a Line in the Merge Buffer for this CacheLine. The partial Write data will be written to that line in the Merge buffer.
Once the Far Memory response to the Merge Buffer, the Cache Line will be filled (without overriding the <code>new</code> word writes)
The TQ entry will become a fill candidate, and eventually will win the arbitration to fill the cache though the Pipe.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="74-write-after-read-same-cache-line-samedifferent-word"><a name="_toc854682441"></a><strong>7.4 Write After Read (Same Cache Line, Same/different Word)</strong><a href="#74-write-after-read-same-cache-line-samedifferent-word" class="hash-link" aria-label="Direct link to 74-write-after-read-same-cache-line-samedifferent-word" title="Direct link to 74-write-after-read-same-cache-line-samedifferent-word">​</a></h2><p>Currently In our architecture, there is no issue with Write after Read due to the fact the incase of a read miss, we stall any new requests from the core until the first miss is resolved. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="75-read-after-read-same-cache-line-samedifferent-word"><a name="_toc2125413379"></a><strong>7.5 Read After Read (Same Cache Line, Same/different Word)</strong><a href="#75-read-after-read-same-cache-line-samedifferent-word" class="hash-link" aria-label="Direct link to 75-read-after-read-same-cache-line-samedifferent-word" title="Direct link to 75-read-after-read-same-cache-line-samedifferent-word">​</a></h2><p>Currently In our architecture, there is no issue with Raed after Read due to the fact the incase of a read miss, we stall any new requests from the core. until the first miss is resolved.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/noamsabb/fpga_mafia_doc/tree/main/docs/cache/Merge_Buffer_Behavior.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/fpga_mafia_doc/docs/cache/High_level_Transaction_Flows"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">&lt;a name=&quot;_toc1967356741&quot;&gt;&lt;/a&gt;&lt;a name=&quot;_toc1779312326&quot;&gt;&lt;/a&gt;**6. High level Transaction Flows**</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/fpga_mafia_doc/docs/cache/Verification"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">&lt;a name=&quot;_toc2123724073&quot;&gt;&lt;/a&gt;**8. Verification**</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#71-read-after-write-same-cache-line-word-hit" class="table-of-contents__link toc-highlight"><a name="_toc761038880"></a><strong>7.1 Read After Write (same Cache Line, word hit)</strong></a></li><li><a href="#72-read-after-write-same-cache-line-word-miss" class="table-of-contents__link toc-highlight"><a name="_toc1647958394"></a><strong>7.2 Read After Write (same Cache Line, word Miss)</strong></a></li><li><a href="#73-write-after-write-same-cache-line-samedifferent-word" class="table-of-contents__link toc-highlight"><a name="_toc1077647588"></a><strong>7.3 Write After Write (Same Cache Line, same/different word)</strong></a></li><li><a href="#74-write-after-read-same-cache-line-samedifferent-word" class="table-of-contents__link toc-highlight"><a name="_toc854682441"></a><strong>7.4 Write After Read (Same Cache Line, Same/different Word)</strong></a></li><li><a href="#75-read-after-read-same-cache-line-samedifferent-word" class="table-of-contents__link toc-highlight"><a name="_toc2125413379"></a><strong>7.5 Read After Read (Same Cache Line, Same/different Word)</strong></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/fpga_mafia_doc/docs/intro">Tuto</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/amichai-bd/fpga_mafia" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 MAFIA Project</div></div></div></footer></div>
<script src="/fpga_mafia_doc/assets/js/runtime~main.5e157adf.js"></script>
<script src="/fpga_mafia_doc/assets/js/main.229969e3.js"></script>
</body>
</html>